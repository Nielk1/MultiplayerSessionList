<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home Page - MultiplayerSessionList</title>
    <!--<link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />-->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!--<link href="/lib/font-awesome/css/font-awesome.min.css" rel="stylesheet" />-->
    <script src="https://kit.fontawesome.com/bf75e31b39.js" crossorigin="anonymous"></script>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">-->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/felipec.min.css">-->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/obsidian.min.css">-->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-dark.min.css">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
</head>
<body>
    <style>
        .chamfer {
            --chamfer-size: 3px;
            clip-path: polygon(var(--chamfer-size) 0, calc(100% - var(--chamfer-size)) 0, 100% var(--chamfer-size), 100% calc(100% - var(--chamfer-size)), calc(100% - var(--chamfer-size)) 100%, var(--chamfer-size) 100%, 0 calc(100% - var(--chamfer-size)), 0 var(--chamfer-size));
        }

        .pre {
            white-space: pre;
        }

        .player_avatars {
            text-align: center;
        }

            .player_avatars a img {
                height: 100px;
            }

            /* ^^^^^ old ^^^^^ */

        .force-ellipsis {
            text-overflow: ellipsis;
            text-wrap: nowrap;
            overflow: hidden;
        }

        @media (max-width: 575.99px) {
            .border-start-xs-0 {
                border-left: 0 !important;
            }
        }

        .border-dotted {
            border-style: dotted !important;
        }
        .border-dashed {
            border-style: dashed !important;
        }

        .icon {
            font-size: small;

            height: 25px;
            width: 25px;
            min-height: 25px;
            min-width: 25px;

            display: block;
            /*clip-path: polygon(2.5px 0, calc(100% - 2.5px) 0, 100% 2.5px, 100% calc(100% - 2.5px), calc(100% - 2.5px) 100%, 2.5px 100%, 0 calc(100% - 2.5px), 0 2.5px);*/
        }
            .icon i {
                width: 25px;
                line-height: 25px;
                font-size: 1.2em;
                text-align: center;
                display: block;
            }
        .icon_lock {
            color: #000;
            background-color: #fe5b5b;
        }
        .icon_sync_bug_lock {
            color: #000;
            background-color: #fe5b5b;
        }

        .icon_password {
            color: #fff;
            background-color: #7f00ff;
        }
        /*.icon_password i {
            transform: rotate(45deg);
        }*/

        .icon_sync_join {
            color: #000;
            background-color: #fe5b5b;
        }
        .icon_sync_script {
            color: #fff;
            background-color: #7f00ff;
            /*color: #000;
            background-color: #4dad54;*/
        }

        .icon_leader {
            color: #fff;
            background-color: #222;
        }

        .icon_host {
            color: #fff;
            background-color: #222;
        }

        .icon_steam {
            color: #fff;
            background-color: #222;
        }
            .icon_steam > i {
                left: -2px;
                position: relative;
                font-size: x-large;
            }

        .game_mode_icon {
            height: 25px;
            width: 25px;
            min-height: 25px;
            min-width: 25px;
            background-size: cover;
            /*display: inline-block;*/
            /*clip-path: polygon(10% 0, 90% 0, 100% 10%, 100% 90%, 90% 100%, 10% 100%, 0 90%, 0 10%);*/
        }
        .nub {
            height: 25px;
            width: 10px;
            min-height: 25px;
            min-width: 10px;
        }
        .game_mode {
            height: 25px;
            background-position: left;
            background-size: 1000000%;
            width: 200px;
            /*clip-path: polygon(2.5px 0, calc(100% - 2.5px) 0, 100% 2.5px, 100% calc(100% - 2.5px), calc(100% - 2.5px) 100%, 2.5px 100%, 0 calc(100% - 2.5px), 0 2.5px);*/
        }

        .game_mode_cell,
        .map_cell {
            width: 200px;
            flex: 0 0 200px;
        }

        .map_name {
            width: 100%;
            /*margin: 2px auto 1px auto;*/
            margin: .25rem auto 0 auto;
        }

        .game_mode_text {
            font-family: "Orbitron", sans-serif;

            /*filter: invert(1) grayscale(1) contrast(9);*/
                filter: brightness(0.8) invert(1) grayscale(1) contrast(1000);
                color: transparent;
                background: inherit;
                background-clip: text;
                font-weight: 800;
                font-variant: small-caps;
                /*font-size: 0.875em;
            text-transform: capitalize;
            line-height: 25px;*/
            }
            .game_mode_text .smallcap {
                font-weight: 1000;
            }
            .game_mode_text .bigcap {
                font-weight: 600;
            }
            /* only good for counts under 20, otherwise we don't add this class */
            .player_number {
                width: 1.5em;
                display: inline-block;
                text-align: center;
            }

        /*.orbitron-bz98r {
            font-family: "Orbitron", sans-serif;
            font-optical-sizing: auto;
            font-weight: <weight>;
            font-style: normal;
        }*/
        body {
            font-family: "Orbitron", sans-serif;
            font-optical-sizing: auto;
            /*font-weight: <weight>;*/
            font-style: normal;
            /*font-variant: small-caps;*/
        }

        [data-bs-theme=dark] {
            --bs-body-bg: #000;
        }
        /*tbody, td, tfoot, th, thead, tr {
            border-style: none;
        }*/
        /*.table>:not(caption)>*>* {
            padding: .2rem .2rem;
        }*/
        /*.gamelist.table>:not(caption)>*>* {*/
        .gamelist>:not(caption)>*>* {
            color: #00ff00;
        }


        .player_info_box {
            /*color: #000000;*/
            /*background: #4dad54;*/
            background: #003f00;
        }

        .player_flex_box {
            /*flex: 0 1 250px;*/
            /*flex: 0 1 calc(max(320px,50%));*/
            flex: 0 1 calc(min(320px,100%));
            /*flex: 1 1 calc(min(320px,100%));*/
            /*flex: 1 1 auto;*/
            /*flex: 0 0 50%;*/
        }
        @media screen and (max-width: 768px) {
            .player_flex_box {
                flex: 0 1 100%;
            }
        }


        .team_name_1 {
            writing-mode: vertical-lr;
            text-align: center;
        }
        .team_name_2 {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-align: center;
        }

        .player_boxes {
            width: 100%;
        }

        .player_box {
            height: 80px;
            width: 80px;
            max-width: inherit;
            /*margin: 0px 2px 4px 2px;*/
            margin: 2px;
        }

            .player_box img {
                padding: .25rem;
                /*background-color: var(--bs-body-bg);
                border: var(--bs-border-width) solid var(--bs-border-color);
                border-radius: var(--bs-border-radius);*/
                /*max-width: 100%;
                height: auto;*/
                height:100%;
                width:100%;
            }

        .session_extra_panel {
            border-bottom: solid 1px;
            border-right: solid 1px;
            /*border-left: solid 1px;*/
            /*border-radius: 0 0 12px 12px;
            padding: 0 4px 4px 4px;*/
            /*border-radius: 12px;*/

            border-radius: 0 12px 12px 0;
            padding: 36px 4px 4px 295px;
            
            margin-top: -36px;
            margin-left: -295px;
            /*position: relative;
            min-height: 277px;*/
            min-height: 280px;

            /*margin-left: -300px;
            padding-left: 304px;*/

            /*pointer-events: none;*/
            width:100%;
        }

        .status_flags,
        .rules_list {
            flex: 0 0 83px;
            width: 83px;
        }

            .rules_list > div {
                height: 25px;
                color: #000;
                background: gray;
                /*clip-path: polygon(2.5px 0, calc(100% - 2.5px) 0, 100% 2.5px, 100% calc(100% - 2.5px), calc(100% - 2.5px) 100%, 2.5px 100%, 0 calc(100% - 2.5px), 0 2.5px);*/
                /*text-align: center;*/
                /*font-size: small;
                line-height: 2em;*/
                font-weight: 1000;
                padding-left: 0.2rem;
                padding-right: 0.2rem;
                box-sizing: content-box;
            }

                .rules_list div.on {
                    color: #000000;
                    /*background: #00ff00;*/
                    background: #4dad54;
                }

                .rules_list div.off {
                    /*color: #000000;
                    background: #ff0000;*/
                    /*color: #ff0000;
                    background: transparent;
                    border: 1px solid #ff0000;*/

                    color: #000;
                    background: #fe5b5b;
                }


        /*.flex-row {
            border: solid blue 1px;
        }
            .flex-row > div {
                border: solid yellow 1px;
            }
        .flex-column {
            border: solid red 1px;
        }
            .flex-column > div {
                border: solid yellow 1px;
            }*/

        #lobbyList:not(.show_extra) .extra_row {
            display: none !important;
        }
        .session_name_box {
            display: none;
        }

        /*@media screen and (max-width: 768px) {*/
        @media screen and (max-width: 992px) {
            .session_extra_panel {
                padding-left: 120px;
                margin-left: -120px;
            }

            /*.game_mode {
                width: 39px;
                clip-path: polygon(5px 0, 34px 0, 39px 5px, 39px 20px, 20px 39px, 5px 25px, 0 20px, 0 5px);
            }*/
            .game_mode {
                width: 25px;
                /*clip-path: polygon(2.5px 0, calc(100% - 2.5px) 0, 100% 2.5px, 100% calc(100% - 2.5px), calc(100% - 2.5px) 100%, 2.5px 100%, 0 calc(100% - 2.5px), 0 2.5px);*/
            }

            .nub {
                display: none;
            }

            .map_name {
                writing-mode: vertical-lr;
                /*height: 240px;*/
                height: 234px;
                /*margin: 0 !important;*/
                /*margin: 0;*/
                margin: 0 0 4px 0;
                width: 25px;
                line-height: 100%;
                transform: rotate(180deg);
            }

            .map_image {
                display: none;
            }

            .game_mode_cell,
            .map_cell {
                width: 25px;
                flex: 0 0 25px;
            }
        }

        @media screen and (max-width: 768px) {
            /* if we're too thin and extra is open, hide the map name in the first row */
            #lobbyList.show_extra .session_name_cell {
                display: none !important;
            }
            /* if we're too thin and extra is open, show the map name in the info section */
            #lobbyList.show_extra .session_name_box {
                display: block;
            }
        }
    </style>

    <!--<style id="extra_data_style">
        .extra_row {
            display: none !important;
        }
    </style>-->

    <div class="container-fluid pt-2 border-bottom mb-2" style="top: 0; position: sticky; z-index: 99999; background-color: var(--bs-body-bg);">
        <p class="d-inline-flex gap-1 float-end">
            <button id="btnExtra" type="button" data-bs-toggle="button" aria-pressed="false" class="btn btn-outline-primary">Extra</button>
            <button id="btnRefresh" type="button" class="btn btn-outline-primary">Refresh</button>
        </p>
        <div class="text-center">
            <h1 class="display-5">Game List Test</h1>
        </div>
    </div>

    <div class="container-fluid">
        <div class="gamelist">
            <!--<thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Type/Mode</th>
                    <th scope="col">Name</th>
                </tr>
            </thead>-->
            <div id="lobbyList">
            </div>
        </div>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container-fluid">
            &copy; 2024 - MultiplayerSessionList
        </div>
    </footer>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <!--<script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>-->
    <script src="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        function encodeAttr(text) {
            const elem = document.createElement('p');
            elem.setAttribute('title', text);
            const elemHtml = elem.outerHTML; // <p title="encodedText"> or maybe <p title='encodedText'>
            // Find out whether the browser used single or double quotes before encodedText
            const quote = elemHtml[elemHtml.search(/['"]/)];
            // Split up the generated HTML using the quote character; take item 1
            return elemHtml.split(new RegExp(quote))[1];
        }

        function escapeHtml(unsafe) {
            if (!unsafe)
                return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // local copy of list data
        var ListData = {};

        // parent data relations so we can walk up to the session when data updates come in
        var DataRefs = {};

        //$(document).ready(function () {
        {
            var windowSearch = window.location.search;
            if (windowSearch.length > 0)
                windowSearch = '?' + windowSearch.substring(1);
            $.ajax({ url: '/api/2.0/games' + windowSearch })
                .done(function (data) {
                    $('#dropdownMenuContainer').empty();
                    for (var i = 0; i < data.length; i++) {
                        var dat = data[i];
                        var sessionRow = $('<a class="dropdown-item" href="#"/>');
                        sessionRow.text(dat.Name);
                        sessionRow.data('value', dat.Key)
                        $('#dropdownMenuContainer').append($('<li>').append(sessionRow));
                    }
                });
        }

        $('#dropdownMenuContainer').click('.dropdown-item', function (e) {
            e.preventDefault();
            var item = $(e.target);
            if (item.hasClass('dropdown-item')) {
                if (item.hasClass('active')) {
                    item.removeClass('active');
                } else {
                    item.addClass('active')
                }
            }
        });

        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }

        // this function merges all the sources into the destination object, and returns the destination object
        // this preserves the destination object's reference, and modifies it in place, but it is also returned so you can use it with a coalesce of a default object
        function MergeIntoFirstObject(target, ...sources) {
            const source = sources.shift();
            if (source === undefined) return MergeIntoFirstObject(target, ...sources); // next source
            if (isObject(target) && isObject(source)) {
                for (const key in source) {
                    if (isObject(source[key])) {
                        if (!target[key]) Object.assign(target, { [key]: {} });
                        MergeIntoFirstObject(target[key], source[key]);
                    } else if (Array.isArray(source[key])) {
                        // assign the array, but then iterate it to look for those references
                        Object.assign(target, { [key]: source[key] });
                        for (var i = 0; i < source[key].length; i++) {
                            if (isObject(source[key][i])) {
                                MergeIntoFirstObject(target[key][i], source[key][i]);
                            }
                        }
                    } else {
                        Object.assign(target, { [key]: source[key] });
                    }
                }
            }

            // no sources left to merge, clean up references
            if (sources.length == 0)
                return target;

            return MergeIntoFirstObject(target, ...sources); // next source
        }

        function MergeReferences(target, parent_type, parent_id) {
            if (!isObject(target))
                return target;

            for (const key in target) {
                // Detect Object or Array
                if (isObject(target[key])) {
                    if (target[key].$ref) {
                        // we're a ref object, so forget the destination entirely and just use the source's reference
                        var split = target[key].$ref.split('/');
                        let frag_type = split[1].replace('~1', '/').replace('~0', '~');
                        let frag_id = split[2].replace('~1', '/').replace('~0', '~');
                        target[key] = ListData[frag_type][frag_id];
                        if (!DataRefs[`${frag_type}\t${frag_id}`])
                            DataRefs[`${frag_type}\t${frag_id}`] = new Set();
                        DataRefs[`${frag_type}\t${frag_id}`].add(`${target.$type || parent_type}\t${target.$id || parent_id}`);
                    } else {
                        MergeReferences(target[key], target.$type || parent_type, target.$id || parent_id);
                    }
                } else if (Array.isArray(target[key])) {
                    for (var i = 0; i < target[key].length; i++) {
                        if (isObject(target[key][i])) {
                            if (target[key][i].$ref) {
                                // we're a ref object, so forget the destination entirely and just use the source's reference
                                var split = target[key][i].$ref.split('/');
                                let frag_type = split[1].replace('~1', '/').replace('~0', '~');
                                let frag_id = split[2].replace('~1', '/').replace('~0', '~');
                                target[key][i] = ListData[frag_type][frag_id];
                                if (!DataRefs[`${frag_type}\t${frag_id}`])
                                    DataRefs[`${frag_type}\t${frag_id}`] = new Set();
                                DataRefs[`${frag_type}\t${frag_id}`].add(`${target.$type || parent_type}\t${target.$id || parent_id}`);
                            } else {
                                MergeReferences(target[key][i], target.$type || parent_type, target.$id || parent_id);
                            }
                        }
                    }
                }
            }
            return target;
        }

        function ExpandDataRefs($type, $id, memo) {
            let local_memo = memo || new Set();

            // if we already have this one end this recursion path
            if (local_memo.has(`${$type}\t${$id}`))
                return local_memo;

            // add ourself to the memo
            local_memo.add(`${$type}\t${$id}`)
            
            if (DataRefs[`${$type}\t${$id}`]) {
                for (let v of DataRefs[`${$type}\t${$id}`]) {
                    let tmp = v.split('\t');
                    ExpandDataRefs(tmp[0], tmp[1], local_memo);
                }
            }

            // return the memo as it's all our unique keys
            return local_memo;
        }

        var GetGamesAjax = null;
        $('#btnExtra').click(function (e) {
            e.preventDefault();
            //const myStyleSheetRule = document.getElementById("extra_data_style").sheet.cssRules[0];
            if ($('#btnExtra').hasClass('active')) {
                //myStyleSheetRule.style.setProperty("display", null);
                $('#lobbyList').addClass('show_extra');
            } else {
                //myStyleSheetRule.style.setProperty("display", "none", "important");
                $('#lobbyList').removeClass('show_extra');
            }
        });
        $('#btnRefresh').click(function (e) {
            e.preventDefault();

            $('#lobbyList').empty();

            if (GetGamesAjax != null) {
                GetGamesAjax.abort();
            }

            // forget any pending datums from a prior refresh
            debouncingDatums = false;
            debouncingSet = new Set();
            if (debouncingTimeout >= 0) {
                clearTimeout(debouncingTimeout);
                console.log("ABORT PENDING POOLING");
            }
            debouncingTimeout = -1;

            DataRefs = {};

            var windowSearch = window.location.search;
            if (windowSearch.length > 0)
                windowSearch = '&' + windowSearch.substring(1);

            // what ugly shit this is
            var keys = [].concat(...$('#dropdownMenuContainer .dropdown-item.active')).map(function (elem) { return 'game=' + $(elem).data('value') }).join('&');

            GetGamesAjax = new XMLHttpRequest();
            GetGamesAjax.open("GET", 'api/2.0/sessions?game=bigboat:battlezone_98_redux' + windowSearch);
            var last_index = 0;
            GetGamesAjax.onprogress = function () {
                var UpdatedThisPass = new Set();

                var end = 0;
                while ((end = GetGamesAjax.responseText.indexOf('\n', last_index)) > -1) {
                    var s = GetGamesAjax.responseText.substring(last_index, end + 1);

                    var data = JSON.parse(s);
                    if (data.$type == 'debug') {
                        console.log(data.$data);
                    } else {
                        ListData[data.$type] = ListData[data.$type] || {};
                        if (data.$type == 'default') {
                            // defaults are wonky, no need to copy their ID and Type back into them as it would just break things reading from them
                            ListData[data.$type][data.$id] = MergeReferences(MergeIntoFirstObject(ListData[data.$type][data.$id] || {}, data.$data));
                        } else {
                            // for everything that isn't a default or a debug copy the $type and $id into it so we have an easier time
                            ListData[data.$type][data.$id] = MergeReferences(MergeIntoFirstObject(ListData[data.$type][data.$id] || {}, { $id: data.$id, $type: data.$type }, (ListData['default'] || {})[data.$type], data.$data));
                        }
                        switch (data.$type) {
                            // tokens we don't care about, even if they updated the composite data (we aren't ever rendering them)
                            //case 'source':
                            //    break;
                            default:
                                UpdatedThisPass.add(`${data.$type}\t${data.$id}`);
                                break;
                        }
                    }

                    last_index = end + 1;
                }
                if (UpdatedThisPass.size > 0)
                    UpdateSessionListWithDataFragments(ListData, UpdatedThisPass);
            };
            GetGamesAjax.onload = function () {

            }
            ListData = {};
            GetGamesAjax.send();
        });

        var parent = document.querySelector('#lobbyList');

        function GenerateHtml_ModBoxes(mod, mods) {
            let modBoxes = '';
            if (mod && mod.dependencies) {
                for (let m of mod.dependencies) {
                    modBoxes += GenerateHtml_ModBox(m, false);
                }
            } else {
                if (mods) {
                    for (let m of mods) {
                        modBoxes += GenerateHtml_ModBox(m, false);
                    }
                }
            }
            return modBoxes;
        }

        // mapId is to allow the map to rewrite the sub-mods section, the modId of the base mod is also applied to allow this
        // mapId isn't actually a way updated can happen anymore so we can probably drop it
        function GenerateHtml_ModsRow(mod, mods, mapId) {
            let htmlOut = '';
            let modBoxes = GenerateHtml_ModBoxes(mod, mods);

            if (mod) {
                htmlOut += `
<div class="col-12 col-sm-4 col-lg-3 col-xl-4 p-1 text-center">
    ${GenerateHtml_ModBox(mod, true) }
</div>
<div class="col-12 col-sm-8 col-lg-9 col-xl-8 border-0 border-start border-start-xs-0 small">
    <div class="row" data-path="mods" data-id-map="${encodeAttr(mapId)}" data-id-mod="${encodeAttr(mod.$id)}">${modBoxes}</div>
</div>`;
            } else {
                htmlOut += `
<div class="col-12 p-0 border-0 small" data-path="mods" data-id-map="${encodeAttr(mapId)}" data-id-mod="${encodeAttr(mod.$id)}">${modBoxes}</div>`;
            }
            return htmlOut
        }

        function GenerateHtml_ModBox(mod, primary) {
            return `
<div class="${primary ? '' : 'col-3 col-sm-2 col-lg-1 col-xl-2'} p-1">
    <div class="ratio ratio-1x1">
        <a class="ratio ratio-1x1" data-path="mod_box_link" ${mod.url ? `href="${encodeAttr(mod.url)}"` : ''} data-type="mod" data-id="${encodeAttr(mod.$id)}" target="_blank">
            <img data-path="mod_box_image" data-type="mod" data-id="${encodeAttr(mod.$id)}" width="250" length="250" src="${encodeAttr(mod.image || '')}" title="${encodeAttr(mod.name || mod.$id)}" onerror="this.src='/img/no_steam_pfp.jpg'" class="img-thumbnail ${primary ? 'border-primary' : ''}" style="width:100%;height:auto;margin:auto;bottom:0;top:0;left:0;right:0;">
        </a>
    </div>
    ${primary ? `
    <div class="shadow-lg p-1 m-auto mb-1 mt-2 ${primary ? 'bg-primary bg-opacity-10 border border-primary text-primary' : 'bg-body-tertiary'} rounded text-truncate text-center">
        <small data-path="mod_box_name" data-type="mod" data-id="${encodeAttr(mod.$id)}" class="card-subtitle text-decoration-none" style="white-space:pre;">${mod.name || mod.$id}</small>
    </div>
    ` : ''}
</div>`;
        }

        function GenerateHtml_IdentitySteam(identity) {
            let platform_name = identity.nickname || identity.$id;
            let platform_profile = identity.profile_url;
            if (platform_profile) {
                return `<a href="${platform_profile}" title="${encodeAttr(platform_name)}" target="_blank" rel="noopener noreferrer" class="chamfer icon icon_steam text-decoration-none me-1" data-id="${encodeAttr(identity.$id)}" data-type="${encodeAttr(identity.$type)}"><i class="fa-brands fa-steam-symbol"></i></a>`;
            } else {
                return `<div title="Steam" class="chamfer icon icon_steam me-1" data-id="${encodeAttr(identity.$id)}" data-type="${encodeAttr(identity.$type)}"><i class="fa-brands fa-steam-symbol"></i></div>`;
            }
        }

        function GenerateHtml_IdentityGog(identity) {
            let platform_name = identity.username || identity.$id;
            let platform_profile = identity.profile_url;
            if (platform_profile) {
                return `<a href="${platform_profile}" title="${encodeAttr(platform_name)}" target="_blank" rel="noopener noreferrer" class="chamfer icon icon_steam text-decoration-none me-1" data-id="${encodeAttr(identity.$id)}" data-type="${encodeAttr(identity.$type)}"><i class="icon icon-gog" aria-hidden="true" title="GOG"></i></a>`;
            } else {
                return `<div title="Steam" class="chamfer icon icon_steam me-1" data-id="${encodeAttr(identity.$id)}" data-type="${encodeAttr(identity.$type)}"><i class="icon icon-gog" aria-hidden="true" title="GOG"></i></div>`;
            }
        }

        function GenerateHtml_Player(player, is_leader, is_over_limit, teamed) {
            let plaform_avatar = '';
            let player_avatar_source = '';
            let player_avatar_id = '';
            for (let id in player.ids) {
                if (id == "steam") {
                    plaform_avatar = (player.ids[id].identity || {}).avatar_url || plaform_avatar;
                    player_avatar_id = player.ids[id].identity.$id;
                    player_avatar_source = id;
                    break;
                }
                if (id == "gog") {
                    plaform_avatar = (player.ids[id].identity || {}).avatar_url || plaform_avatar;
                    player_avatar_id = player.ids[id].identity.$id;
                    player_avatar_source = id;
                    break;
                }
            }

            let playerHtmlEntries = '';
            //<div class="chamfer d-flex" style="background:black;flex:100% 0 0;">
            playerHtmlEntries += `
    <div data-path="player" data-type="player" data-id="${encodeAttr(player.$id ?? "")}" data-extra-leader="${is_leader ? true : false}" data-extra-overlimit="${is_over_limit ? true : false}">
        <div class="player_info_box chamfer d-flex flex-row flex-nowrap ${teamed ? '' : 'me-1 mb-1'}" style="padding:2px;">
            <div class="chamfer d-flex" style="background:black;flex:100% 0 0;">
                <div class="d-flex m-1" style="flex: 0 0 50px;width:50px;">
                    <img data-path="avatar" data-source="${encodeAttr(player_avatar_source)}" data-id="${encodeAttr(player_avatar_id)}" src="${encodeAttr(plaform_avatar)}" width="150" height="150" onerror="this.src = '/img/no_steam_pfp.jpg'" class="img-fluid chamfer">
                </div>
                <div class="d-flex flex-column" style="flex: 0 1 100%;">
                    <div class="force-ellipsis">${escapeHtml(player.name)}</div>`;

            playerHtmlEntries += `
                <div class="d-flex flex-row">
                    ${is_leader ? '<div title="Leader" class="chamfer icon icon_leader me-1"><i class="fa-solid fa-crown"></i></div>' : ''}
                    ${player.is_host ? '<div title="Host" class="chamfer icon icon_host me-1"><i class="fa-solid fa-server"></i></div>' : ''}`;

            for (let id in player.ids) {
                switch (id) {
                    case "slot":
                        //{
                        //    let platform_id = '' + player.ids[id].id;
                        //    playerHtmlEntries += `<div class="force-ellipsis"><i class="icon icon-hash" aria-hidden="true" title="Slot"></i> ${escapeHtml(platform_id)}</a></div>`;
                        //}
                        break;
                    case "bzr_net":
                        //{
                        //    let platform_id = '' + player.ids[id].id;
                        //    playerHtmlEntries += `<div class="force-ellipsis"><i class="fa fa-gamepad" aria-hidden="true" title="BZR-Net"></i> ${escapeHtml(platform_id)}</a></div>`;
                        //}
                        break;
                    case "steam":
                        {
                            playerHtmlEntries += GenerateHtml_IdentitySteam(player.ids[id].identity);
                        }
                        break;
                    case "gog":
                        {
                            playerHtmlEntries += GenerateHtml_IdentityGog(player.ids[id].identity);
                        }
                        break;
                    default:
                        break;
                }
            }

            playerHtmlEntries += `</div>`;

            //if (player.hero) {
            //    playerHtmlEntries += `<div class="force-ellipsis"><i class="fa fa-user-circle-o" aria-hidden="true" title="Hero"></i> <span data-path="hero_name" data-type="hero" data-id="${encodeAttr(player.hero.$id)}">${escapeHtml(player.hero.name || player.hero.$id)}</span></div>`;
            //}

            //if (player.stats)
            //    playerHtmlEntries += GenerateHtml_MicroList("Stats", player.stats, true);
            //if (player.other)
            //    playerHtmlEntries += GenerateHtml_MicroList("Other", player.other, true);

            playerHtmlEntries += `
            </div>`

            if (player.hero) {
                playerHtmlEntries += `
            <div class="d-flex m-1" style="flex: 0 0 50px;width:50px;">
                <img data-path="hero_name" data-type="hero" data-id="${encodeAttr(player.hero.$id)}" title="${encodeAttr(player.hero.name || player.hero.$id)}" src="/img/no_steam_pfp.jpg" width="150" height="150" onerror="this.src = '/img/no_steam_pfp.jpg'" class="img-fluid chamfer">
            </div>`;
            } else {
                playerHtmlEntries += `
            <div class="d-flex m-1 d-block chamfer" style="flex: 0 0 50px;width:50px;background:green;">
            </div>`;
            }

            playerHtmlEntries += `
        </div>
    </div>
</div>`;
            return playerHtmlEntries;
        }

        function CreateOrUpdateSessionDom($id, data) {
            var session = data.session[$id];
            var sessionDom = parent.querySelector(`#\\/session\\/${CSS.escape($id)}`);
            var sessionDom2 = parent.querySelector(`#\\/session\\/${CSS.escape($id)}\\/row2`);

            if (!sessionDom) {
                parent.insertAdjacentHTML('beforeend', `<div class="mb-1 d-flex flex-row flex-nowrap" id="/session/${encodeAttr($id)}">
                    <div class="me-1 status_flags d-flex flex-row justify-content-between">
                        <div>
                            <div data-path="session.status.is_locked_off" class="icon"></div>
                            <div title="Locked" data-path="session.status.is_locked" class="chamfer icon icon_lock" style="display:none;"><i class="fa-solid fa-lock"></i></div>
                            <div title="Effectively Locked via Sync Join Bug" data-path="session.status.other.sync_bug" class="chamfer icon icon_sync_bug_lock" style="display:none;"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        </div>
                        <div>
                            <div data-path="session.status.has_password_off" class="icon"></div>
                            <div title="Password" data-path="session.status.has_password" class="chamfer icon icon_password" style="display:none;"><i class="fa-solid fa-key"></i></div>
                        </div>
                        <div>
                            <div data-path="session.other.sync_join_off" class="icon"></div>
                            <div title="Sync Join" data-path="session.other.sync_join" class="chamfer icon icon_sync_join" style="display:none;"><i class="fa-solid fa-chain"></i></div>
                            <div title="Scripted Sync" data-path="session.other.sync_script" class="chamfer icon icon_sync_script" style="display:none;"><i class="fa-solid fa-handshake-angle"></i></div>
                        </div>
                    </div>
                    <div class="me-1 d-flex game_mode_cell">
                        <div class="d-flex flex-row">
                            <div class="chamfer game_mode d-flex flex-row" data-path="session.level.game_mode">
                                <div class="nub" style="border-right:solid black 2px; box-sizing: content-box;" data-path="session.level.game_type"></div>
                                <div class="game_mode_icon" data-path="session.level.game_mode.icon"></div>
                                <span class="game_mode_text ps-1 pe-1 force-ellipsis" data-path="session.level.game_mode.text"></span>
                            </div>
                        </div>
                    </div>
                    <div style="flex:0 1 50%;" class="me-1 d-flex flex-grow-1 text-truncate"><span class="force-ellipsis" data-path="session.level.map"></span></div>
                    <div style="flex:0 1 50%;" class="me-1 d-flex flex-grow-1 text-truncate session_name_cell"><span class="force-ellipsis" data-path="session.name"></span></div>
                    <div style="flex:0 0 0;" class="me-1 text-nowrap bg-transparent text-end" data-path="session.player_count"></div>
                </div>
                <div class="mb-2 d-flex flex-row flex-nowrap extra_row" id="/session/${encodeAttr($id)}/row2">
                    <div class="me-1 rules_list d-flex flex-column" data-path="session.level.rules"></div>
                    <div class="map_cell d-flex me-1 flex-column text-center">
                        <div class="map_image chamfer bg-secondary">
                            <div style="background: black; left: 1px; top: 1px; height: calc(100% - 2px); width: calc(100% - 2px); position: relative;" class="chamfer">
                                <div class="ratio ratio-1x1" style="--bs-aspect-ratio: calc(100% + 2px);top: -1px;">
                                    <img class="chamfer" data-path="session.level.map.image" width="186" length="186" src onerror="this.src='/img/no_steam_pfp.jpg'" class="img-thumbnail" style="width:calc(100% - 12px);height:auto;margin:auto;bottom:0;top:0;left:0;right:0;">
                                </div>
                            </div>
                        </div>
                        <div class="map_name p-1 bg-body-tertiary chamfer text-truncate small">
                            <small data-path="session.level.map.map_file" class="card-subtitle text-body-secondary" style="white-space:pre;"></small>
                        </div>
                    </div>
                    <div class="session_extra_panel" style="flex:3 0 0;overflow-x:hidden;">
                        <div class="session_name_box text-truncate"><span class="force-ellipsis" data-path="session.name"></span></div>
                        <div data-path="players" class="d-flex flex-row flex-wrap justify-content-evenly"></div>
                    </div>
                </div>`);
                //<div data-path="players" class="row g-0" style="margin-right: -.25rem !important;"></div>
                //<div class="icon" style="border-right:solid black 2px; box-sizing: content-box;" data-path="session.level.game_type"></div>
                sessionDom2 = parent.lastElementChild;
                sessionDom = sessionDom2.previousElementSibling;
                //sessionDom = parent.lastElementChild;
            }

            // Map Image
            sessionDom2.querySelector('[data-path="session.level.map.image"]').setAttribute("src", session.level?.map?.image ?? "");

            // Map Filename
            sessionDom2.querySelector('[data-path="session.level.map.map_file"]').textContent = session.level?.map?.map_file ?? " ";

            // Map Name
            //let map_name_elem = sessionDom.querySelector('[data-path="session.level.map.name"]');
            //map_name_elem.setAttribute('title', session.level?.map?.map_file);
            //map_name_elem.textContent = session.level?.map?.name ?? session.level?.map?.map_file ?? '';

            // Game Version
            //sessionDom.querySelector('[data-path="session.game.version"]').textContent = session.game?.version || " ";

            // Session Name
            let sessionNameElem = sessionDom.querySelector('[data-path="session.name"]');
            let sessionNameElem2 = sessionDom2.querySelector('[data-path="session.name"]');
            if (session.name && session.name.trim().length > 0) {
                sessionNameElem.textContent = session.name;
                sessionNameElem.style.fontStyle = null;
                sessionNameElem2.textContent = session.name;
                sessionNameElem2.style.fontStyle = null;
            } else {
                sessionNameElem.textContent = "<INTENTIONALLY BLANK>";
                sessionNameElem.style.fontStyle = "italic";
                sessionNameElem2.textContent = "<INTENTIONALLY BLANK>";
                sessionNameElem2.style.fontStyle = "italic";
            }

            // Map Name
            let sessionMapNameElem = sessionDom.querySelector('[data-path="session.level.map"]');
            if (session?.level?.map?.name) {
                sessionMapNameElem.textContent = session?.level?.map?.name;
                //sessionMapNameElem.style.fontStyle = null;
            } else {
                sessionMapNameElem.textContent = session?.level?.map?.map_file;
                //sessionMapNameElem.style.fontStyle = "italic"; // TODO this was breaking flex style
            }

            // Session Message
            //sessionDom.querySelector('[data-path="session.message"]').textContent = session.message || " ";

            // Locked
            if (session?.status?.other?.sync_bug ?? false) {
                sessionDom.querySelector('[data-path="session.status.is_locked_off"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.is_locked"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.other.sync_bug"]').style.display = "block";
            }
            else if (session?.status?.is_locked ?? false) {
                sessionDom.querySelector('[data-path="session.status.is_locked_off"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.other.sync_bug"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.is_locked"]').style.display = "block";
            }
            else
            {
                sessionDom.querySelector('[data-path="session.status.is_locked"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.other.sync_bug"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.is_locked_off"]').style.display = "block";
            }

            // Password
            if (session?.status?.has_password ?? false) {
                sessionDom.querySelector('[data-path="session.status.has_password_off"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.has_password"]').style.display = "block";
            }
            else
            {
                sessionDom.querySelector('[data-path="session.status.has_password"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.status.has_password_off"]').style.display = "block";
            }

            // Sync Join
            if (session?.other?.sync_join ?? false) {
                sessionDom.querySelector('[data-path="session.other.sync_join_off"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.other.sync_join"]').style.display = "block";
                sessionDom.querySelector('[data-path="session.other.sync_script"]').style.display = "none";
            }
            else if (session?.other?.sync_script ?? false) {
                sessionDom.querySelector('[data-path="session.other.sync_join_off"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.other.sync_join"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.other.sync_script"]').style.display = "block";
            }
            else
            {
                sessionDom.querySelector('[data-path="session.other.sync_join_off"]').style.display = "block";
                sessionDom.querySelector('[data-path="session.other.sync_join"]').style.display = "none";
                sessionDom.querySelector('[data-path="session.other.sync_script"]').style.display = "none";
            }

            


            // Session Game Type
            let game_type_element = sessionDom.querySelector(`[data-path="session.level.game_type"]`);
            game_type_element.setAttribute("title",
                session.level?.rules?.game_type?.name ?? session.level?.rules?.game_type?.$id ??
                session.level?.map?.game_type?.name ?? session.level?.map?.game_type?.$id ??
                session.level?.game_type?.name ?? session.level?.game_type?.$id ?? "Unknown");
            let game_type_icon =
                session.level?.rules?.game_type?.icon ??
                session.level?.map?.game_type?.icon ??
                session.level?.game_type?.icon ?? null;
            let game_type_color =
                session.level?.rules?.game_type?.color ??
                session.level?.map?.game_type?.color ??
                session.level?.game_type?.color ?? null;
            if (game_type_color) {
                game_type_element.style.backgroundColor = game_type_color;
            } else {
                game_type_element.style.backgroundColor = "#101010";
            }
            //if (game_type_icon) {
            //    game_type_element.style.backgroundImage = `url("${game_type_icon}")`;
            //} else {
            //    game_type_element.style.backgroundImage = 'url("//gamelistassets.iondriver.com/bz98r/icons/icon_unknown.png")';
            //}

            // Session Game Mode
            let game_mode_element = sessionDom.querySelector(`[data-path="session.level.game_mode"]`);
            let game_mode_icon_element = sessionDom.querySelector(`[data-path="session.level.game_mode.icon"]`);
            let game_mode_text_element = sessionDom.querySelector(`[data-path="session.level.game_mode.text"]`);
            game_mode_element.setAttribute("title",
                session.level?.rules?.game_mode?.name ?? session.level?.rules?.game_mode?.$id ??
                session.level?.map?.game_mode?.name ?? session.level?.map?.game_mode?.$id ??
                session.level?.game_mode?.name ?? session.level?.game_mode?.$id ?? "Unknown");
            let game_mode_text_string =
                session.level?.rules?.game_mode?.name ?? session.level?.rules?.game_mode?.$id ??
                session.level?.map?.game_mode?.name ?? session.level?.map?.game_mode?.$id ??
                session.level?.game_mode?.name ?? session.level?.game_mode?.$id ?? "Unknown";
            game_mode_text_element.innerHTML = game_mode_text_string.split(/(?<=[A-Z])(?=[a-z ])|(?<=[a-z ])(?=[A-Z])/).map(i => `<span class="${i == i.toLowerCase() ? 'smallcap' : 'bigcap'}">${escapeHtml(i)}</span>`).join('');
            let game_mode_icon =
                session.level?.rules?.game_mode?.icon ??
                session.level?.map?.game_mode?.icon ??
                session.level?.game_mode?.icon ?? null;
            let game_mode_color =
                session.level?.rules?.game_mode?.color ??
                session.level?.map?.game_mode?.color ??
                session.level?.game_mode?.color ?? null;
            if (game_mode_color) {
                game_mode_element.style.backgroundColor = game_mode_color;
                game_mode_element.style.backgroundImage = "";
            } else if (game_mode_icon) {
                game_mode_element.style.backgroundImage = `url("${game_mode_icon}")`; // do coloring via icon image
                game_mode_element.style.backgroundColor = "";
            } else {
                game_mode_element.style.backgroundImage = "";
                game_mode_element.style.backgroundColor = "#101010";
            }
            if (game_mode_icon) {
                game_mode_icon_element.style.backgroundImage = `url("${game_mode_icon}")`;
            } else {
                game_mode_icon_element.style.backgroundImage = 'url("//gamelistassets.iondriver.com/bz98r/icons/icon_unknown.png")';
            }

            // Session Level Rules
            let sessionRulesElem = sessionDom2.querySelector(`[data-path="session.level.rules"]`);
            if (session.level.rules) {
                let htmlEntries = '';
                for (let prop in session.level.rules) {
                    if (session.level.rules[prop] != null) {
                        switch (prop) {
                            case 'lives'      : htmlEntries += `<div class=                                            "chamfer d-flex flex-row mb-1" style="white-space:pre;" title="${encodeAttr('' + session.level.rules[prop])} Lives"   ><div class="icon"><i class="fa-solid fa-user-group"  ></i></div><div class="flex-grow-1 text-center">${escapeHtml('' + session.level.rules[prop])}</div></div>`; break;
                            case 'kill_limit' : htmlEntries += `<div class=                                            "chamfer d-flex flex-row mb-1" style="white-space:pre;" title="${encodeAttr('' + session.level.rules[prop])} Kills"   ><div class="icon"><i class="fa-solid fa-skull"       ></i></div><div class="flex-grow-1 text-center">${escapeHtml('' + session.level.rules[prop])}</div></div>`; break;
                            case 'time_limit' : htmlEntries += `<div class=                                            "chamfer d-flex flex-row mb-1" style="white-space:pre;" title="Time Limit ${session.level.rules[prop]} Minutes"       ><div class="icon"><i class="fa-solid fa-stopwatch"   ></i></div><div class="flex-grow-1 text-center">${escapeHtml(`${Math.floor(session.level.rules[prop] / 60)}:${String(session.level.rules[prop] % 60).padStart(2, '0')}`)}</div></div>`; break;
                            case 'satellite'  : htmlEntries += `<div class="${session.level.rules[prop] ? "on" : "off"} chamfer d-flex flex-row mb-1" style="white-space:pre;" title= "Satellite ${session.level.rules[prop] ? "On" : "Off"}"><div class="icon"><i class="fa-solid fa-satellite"   ></i></div><div class="flex-grow-1 text-center">${session.level.rules[prop] ? 'ON' : 'OFF'}</div></div>`; break;
                            case 'barracks'   : htmlEntries += `<div class="${session.level.rules[prop] ? "on" : "off"} chamfer d-flex flex-row mb-1" style="white-space:pre;" title=  "Barracks ${session.level.rules[prop] ? "On" : "Off"}"><div class="icon"><i class="fa-solid fa-tent"        ></i></div><div class="flex-grow-1 text-center">${session.level.rules[prop] ? 'ON' : 'OFF'}</div></div>`; break;
                            case 'sniper'     : htmlEntries += `<div class="${session.level.rules[prop] ? "on" : "off"} chamfer d-flex flex-row mb-1" style="white-space:pre;" title=    "Sniper ${session.level.rules[prop] ? "On" : "Off"}"><div class="icon"><i class="fa-solid fa-person-rifle"></i></div><div class="flex-grow-1 text-center">${session.level.rules[prop] ? 'ON' : 'OFF'}</div></div>`; break;
                            case 'splinter'   : htmlEntries += `<div class="${session.level.rules[prop] ? "on" : "off"} chamfer d-flex flex-row mb-1" style="white-space:pre;" title=  "Splinter ${session.level.rules[prop] ? "On" : "Off"}"><div class="icon"><i class="fa-solid fa-explosion"   ></i></div><div class="flex-grow-1 text-center">${session.level.rules[prop] ? 'ON' : 'OFF'}</div></div>`; break;
                            default: htmlEntries += `<div class="force-ellipsis text-center chamfer d-flex flex-row mb-1" style="white-space:pre;" title="${encodeAttr(prop)}">${escapeHtml('' + session.level.rules[prop])}</div>`; break;
                        }
                    }
                }

                {
                    // Session Game Balance
                    let game_balance_data =
                        session.level?.rules?.game_balance ??
                        session.level?.map?.game_balance ??
                        session.level?.game_balance ??
                        session.game?.game_balance;

                    if (game_balance_data) {
                        htmlEntries += `<div class="chamfer d-flex flex-row mb-1" style="white-space:pre;" title="${game_balance_data.note ?? `Balance: ${game_balance_data?.name ?? game_balance_data?.$id}`}"><div class="icon"><i class="fa-solid fa-scale-balanced"></i></div><div class="flex-grow-1 text-center">${game_balance_data?.name ?? game_balance_data?.$id}</div></div>`;
                    }
                }

                sessionRulesElem.innerHTML = htmlEntries;

            } else {
                sessionRulesElem.innerHTML = '';
            }

            // Session Game Balance
            //let game_balance_element = sessionDom.querySelector(`[data-path="session.level.game_balance"]`);
            //let game_balance_data =
            //    session.level?.rules?.game_balance ??
            //    session.level?.map?.game_balance ??
            //    session.level?.game_balance ??
            //    session.game?.game_balance;
            //
            //if (game_balance_data) {
            //    game_balance_element.textContent = game_balance_data?.name ?? game_balance_data?.$id;
            //    if (game_balance_data.note) {
            //        game_balance_element.setAttribute("title", game_balance_data.note);
            //    } else {
            //        game_balance_element.removeAttribute("title");
            //    }
            //} else {
            //    game_balance_element.textContent = '';
            //    game_balance_element.removeAttribute("title");
            //}



            // Session Time
            //if (session.time) {
            //    let timeElem = sessionDom.querySelector(`[data-path="session.time"]`);
            //
            //    // minute resolutions
            //    if (session.time.resolution == 60) {
            //        timeElem.textContent = `(${session.time.context ? `${session.time.context} for ` : ''}${session.time.seconds / 60}${session.time.max ? '+' : ''} minutes)`;
            //    } else {
            //        timeElem.textContent = `(${session.time.context ? `${session.time.context} for ` : ''}${session.time.seconds}${session.time.max ? '+' : ''} seconds)`;
            //    }
            //}

            // Session Status
            //if (session.status?.state) {
            //    let timeElem = sessionDom.querySelector(`[data-path="session.status.state"]`);
            //    timeElem.textContent = session.status.state;
            //}

            // Player Count Text
            if (session.player_types != null) {
                let player_count_string = '';
                for (let k = 0; k < session.player_types.length; k++) {
                    if (k > 0 && playerTypePad)
                        player_count_string += ',';
                    for (let L = 0; L < session.player_types[k].types.length; L++) {
                        let playerType = session.player_types[k].types[L];
                        let playerTypeHtml = null;
                        let playerTypePad = false;
                        switch (playerType) {
                            case "player": playerTypeHtml = '<i title="Players" class="bi bi-person-fill"></i>'; break;
                            case "spectator": playerTypeHtml = '<i title="Spectators" class="bi bi-camera-video-fill"></i>'; break;
                            case "audience": playerTypeHtml = '<i title="Audience" class="fa fa-users" aria-hidden="true"></i>'; break;
                            default: playerTypeHtml = ' ' + playerType; playerTypePad = true; break;
                        }
                        if (L > 0 && playerTypePad)
                            player_count_string += ' ';
                        let count = session.player_count[playerType] + 0;
                        if (count > 19) {
                            player_count_string += `<span>${count}</span>${playerTypeHtml}`;
                        } else {
                            player_count_string += `<span class="player_number">${count}</span>${playerTypeHtml}`;
                        }
                    }
                    let count_max = session.player_types[k].max;
                    if (count_max) {
                        if (count_max > 19) {
                            player_count_string += `/<span>${session.player_types[k].max}</span>`;
                        } else {
                            player_count_string += `/<span class="player_number">${session.player_types[k].max}</span>`;
                        }
                    }
                }
                sessionDom.querySelector(`[data-path="session.player_count"]`).innerHTML = player_count_string;
            }

            // Players
            {
                function microSort(a, b) {
                    if (a < b) return -1;
                    if (a > b) return 1;
                    return 0;
                }
                let Teams = new Set();
                for (var i = 0; i < session.players.length; i++) {
                    if (session.players[i].team) {
                        Teams.add(session.players[i].team.id);
                    } else {
                        Teams.add(null);
                    }
                }
                if (session.teams) {
                    for (var t in session.teams) {
                        Teams.add(t);
                    }
                }
                if (session.level?.map?.teams) {
                    for (var t in session.level.map.teams) {
                        Teams.add(t);
                    }
                }
                Teams = Array.from(Teams).sort();
                let team_balance = -1;
                let max_players = -1;
                let total_players = session.player_count?.player ?? -1;
                if (session.player_types) {
                    let team_count = Teams.filter(dr => dr != null && !(session.teams?.[dr]?.computer === true && !session.teams?.[dr]?.human)).length;
                    if (team_count > 1) {
                        let matchingTypes = session.player_types.filter(dr => dr.types.indexOf('player') >= 0);
                        if (matchingTypes.length > 0 && matchingTypes[0].max) {
                            max_players = matchingTypes[0].max;
                            team_balance = Math.floor(max_players / team_count);
                        }
                    }
                }
                let playerListDom = sessionDom2.querySelector('[data-path="players"]');
                playerListDom.innerHTML = '';
                let wrappedPlayers = session.players.map(p => {
                    let retVal = { player: p, team: null, leader: false };

                    if (!retVal.team && p.team) {
                        retVal.team = p.team.id;
                        retVal.leader = p.team.leader;
                    }

                    return retVal;
                });
                let teamCounter = 0;
                for (let team of Teams) {
                    let in_team = team != null;
                    let teamName = session.teams?.[team]?.name || session.level?.map?.teams?.[team]?.name || `Team ${team}`;
                    let teamPlayers = wrappedPlayers
                        .filter(p => p.team == team)
                        .sort((a, b) => {
                            let c = microSort(a.player?.team?.index ?? -1, b.player?.team?.index ?? -1);
                            if (c != 0) return c;
                            return microSort(a.player?.index ?? -1, b.player?.index ?? -1);
                        });

                    let playerHtmlEntries = '';

                    var player_count = teamPlayers.length;
                    if (session.teams?.[team])
                        if (max_players > -1 && total_players > -1 && session.teams[team].max) {
                            player_count = Math.max(Math.min(max_players - (total_players - teamPlayers.length), session.teams[team].max), teamPlayers.length);
                        } else {
                            player_count = Math.max(session.teams[team].max ?? player_count, teamPlayers.length, team_balance);
                        }
                    for (var i = 0; i < player_count; i++) {
                        if (i < teamPlayers.length) {
                            let player = teamPlayers[i];

                            let is_over_limit = session.teams?.[team]?.max && i > session.teams[team].max;
                            let is_leader = null;

                            if (team) {
                                playerHtmlEntries += '<div class="player_flex_box">';
                                //playerHtmlEntries += '<div style="flex:1 1 auto;">';
                                //playerHtmlEntries += '<div style="flex:0 0 300px;">';
                                //playerHtmlEntries += '<div class="col-6 col-md-4 col-lg-3">';
                                //playerHtmlEntries += '<div class="col-12">';
                                is_leader = player.leader; // can't have a team leader without a team (I guess some games will be 1 team?)
                            } else {
                                playerHtmlEntries += '<div class="player_flex_box">';
                                //playerHtmlEntries += '<div style="flex:1 1 auto;">';
                                //playerHtmlEntries += '<div style="flex:0 0 300px;">';
                                //playerHtmlEntries += '<div class="col-6 col-md-4 col-lg-3">';
                            }
                            playerHtmlEntries += GenerateHtml_Player(player.player, is_leader, is_over_limit, in_team);
                            playerHtmlEntries += '</div>';

                        } else {
                            let is_beyond_balance = team_balance >= 0 && i >= team_balance;

//                            playerHtmlEntries += `
//<div class="col-6 col-md-4">
//    <div class="d-block p-2 rounded border ${is_beyond_balance ? 'border-dashed opacity-50' : ''} text-secondary ps-3 text-bg-secondary bg-opacity-10 d-flex align-items-center h-100">
//        <span class="text-nowrap overflow-hidden align-middle">
//            <i class="fa fa-user" aria-hidden="true"></i> Open
//        </span>
//    </div>
//</div>`;
//                            playerHtmlEntries += `
//<div class="col-6 col-md-4">
//    <div class="player_info_box chamfer d-flex" style="padding:2px;">
//        <div class="chamfer d-flex" style="background:black;flex:100% 0 0;">
//            <div class="m-1 ms-0">
//                <span class="text-nowrap overflow-hidden align-middle">
//                    <i class="fa fa-user" aria-hidden="true"></i> Open
//                </span>
//            </div>
//        </div>
//    </div>
//</div>`;
                        }
                    }
                    if (!session.teams?.[team]?.human && session.teams?.[team]?.computer === true) {
//                        playerHtmlEntries += `
//<div class="col-6 col-md-4">
//    <div class="d-block p-2 rounded border border-danger text-danger ps-3 text-bg-danger bg-opacity-10 d-flex align-items-center h-100">
//        <span class="text-nowrap overflow-hidden align-middle">
//            <i class="fa fa-desktop" aria-hidden="true"></i> Computer
//        </span>
//    </div>
//</div>`;
                    }

                    if (team) {
                        if (!session.teams?.[team]?.human && session.teams?.[team]?.computer === true) {
//                            playerListDom.insertAdjacentHTML('beforeend', `
//<div class="col-6 col-md-4">
//    <div class="card h-100 border-danger" style="--bs-border-opacity: .35;">
//        <div data-path="team_name" data-id-team="${encodeAttr(team)}" data-id-map="${session.level?.map?.$id ? encodeAttr(session.level.map.$id) : ''}" class="small card-header d-flex justify-content-center text-bg-danger">${escapeHtml(teamName)}</div>
//        <div class="row g-0">${playerHtmlEntries}</div>
//    </div>
//</div>`);
                        } else {
                            playerListDom.insertAdjacentHTML('beforeend', `
<div class="col-12">
    <div class="player_info_box chamfer me-1">
        <div data-path="team_name" data-id-team="${encodeAttr(team)}" data-id-map="${session.level?.map?.$id ? encodeAttr(session.level.map.$id) : ''}" class="small card-header d-flex justify-content-center chamfer" style="background:black;margin: 0 2px 2px 2px;top: 2px;position: relative;">${escapeHtml(teamName)}</div>
        <div class="d-flex flex-row flex-wrap justify-content-evenly">${playerHtmlEntries}</div>
    </div>
</div>
${(Teams.length > 1 && (teamCounter + 1) < Teams.length) ? '<hr class="m-2 col-12" style="border-color: #00ff00!important;opacity: 100%;">' : ''}`);
                        }
                    } else {
                        playerListDom.insertAdjacentHTML('beforeend', `
${playerHtmlEntries}
${(Teams.length > 1 && (teamCounter + 1) < Teams.length) ? '<hr class="m-2 col-12" style="border-color: #00ff00!important;opacity: 100%;">' : ''}`);
                    }

                    teamCounter++;
                }
            }
        }

        let debouncingDatums = false;
        let debouncingSet = new Set();
        let debouncingTimeout = -1;
        function UpdateSessionListWithDataFragments(data, modified) {
            for (const mod of modified) {
                var $parts = mod.split('\t', 2);
                var $type = $parts[0];
                var $id = $parts[1];

                // set of all affected items by the incoming datum
                let affected_set = ExpandDataRefs($type, $id);

                if (affected_set) {
                    for (let v of affected_set) {
                        //console.log(v);
                        let tmp = v.split('\t');
                        debouncingSet.add(`${tmp[0]}\t${tmp[1]}`)
                    }
                    if (!debouncingDatums) {
                        debouncingDatums = true;
                        debouncingTimeout = setTimeout(() => {
                            console.log("START PENDING POOLING");
                            for (const affected of debouncingSet) {
                                let tmp = affected.split('\t');
                                console.log("Pending Datum Triggered", tmp[0], tmp[1])
                                if (tmp[0] == 'session') {
                                    CreateOrUpdateSessionDom(tmp[1], data);
                                }
                            }
                            debouncingSet = new Set();
                            debouncingDatums = false;
                            debouncingTimeout = -1;
                            console.log("END PENDING POOLING");
                        }, 250);
                    }
                }
            }
        }
    </script>
</body>
</html>
